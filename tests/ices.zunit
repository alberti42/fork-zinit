#!/usr/bin/env zunit

@setup {
  ZPLUGINS=$ZINIT[PLUGINS_DIR]
  function _zunit_assert_not_exists(){
    local file_path=$1
    if [[ "${file_path:0:1}" != "/" ]]; then # relative path - prepend the test directory
      filepath="${testdir}/${file_path}"
    fi
    [[ ! -e "$file_path" ]] && return 0
    exit "found '${file_path}'"
  }
}

@test 'mv' {
  run zinit as"null" id-as"test/mv" mv"readme.md -> mv.md" for zdharma-continuum/null
  assert $state equals 0
  assert "$ZPLUGINS/test---mv/mv.md" is_file
  assert "$ZPLUGINS/test---mv/mv.md" is_readable
  assert "$ZPLUGINS/test---mv/readme.md" not_exists
}
@test 'cp' {
  run zinit as"null" id-as"test/cp" cp"readme.md -> cp.md" for zdharma-continuum/null
  assert $state equals 0
  assert "$ZPLUGINS/test---cp/cp.md" is_file
  assert "$ZPLUGINS/test---cp/cp.md" is_readable
  assert "$ZPLUGINS/test---cp/readme.md" is_file
}
@test 'atclone' {
  run zinit as"null" id-as"test/atclone" atclone"mv readme.md atclone.md" for zdharma-continuum/null
  assert $state equals 0
  assert "$ZPLUGINS/test---atclone/atclone.md" is_file
  assert "$ZPLUGINS/test---atclone/atclone.md" is_readable
  assert "$ZPLUGINS/test---atclone/readme.md" not_exists
}
@test 'make' {
  run zinit as"null" id-as"test/make" atclone"printf 'all:\n\ttouch whatever\n' > Makefile" make"all" for zdharma-continuum/null
  assert $state equals 0
  assert "$ZPLUGINS/test---make/whatever" is_file
}
@test 'completions' {
  run zinit as"null" id-as"test/completions" atclone"touch _whatever" completions for zdharma-continuum/null
  assert $state equals 0
  assert "$ZPLUGINS/test---completions/_whatever" is_file
  assert "$ZINIT[COMPLETIONS_DIR]/_whatever" is_file
}
@test 'completions-overwrite' {
  # if both are given, the completions wins
  run zinit as"null" id-as"test/completions-overwrite" atclone"touch _whatever2" nocompletions completions for zdharma-continuum/null
  assert $state equals 0
  assert "$ZPLUGINS/test---completions-overwrite/_whatever2" is_file
  assert "$ZINIT[COMPLETIONS_DIR]/_whatever2" is_file
}
@test 'completions-ignored' {
  # only the _valid file should be installed as a completion
  run zinit as"null" id-as"test/ignored_completions" atclone"touch __init__.py _valid" completions for zdharma-continuum/null
  assert $state equals 0
  assert "$ZPLUGINS/test---ignored_completions/_valid" is_file
  assert "$ZPLUGINS/test---ignored_completions/__init__.py" is_file
  assert "$ZINIT[COMPLETIONS_DIR]/_valid" is_file
  COMPS=( "$ZINIT[COMPLETIONS_DIR]"/_* )
  assert __init__.py is_not_value_in $COMPS
}

@test 'ziextract-permissions' {
  # Create a temp dir with test files, build a zip, and install via extract ice
  local tmpdir
  tmpdir=$(mktemp -d)

  # run_me.sh: +x in archive, has shebang  → must be executable
  printf '#!/bin/sh\necho run\n' > "$tmpdir/run_me.sh"
  chmod +x "$tmpdir/run_me.sh"

  # also_run.py: no +x in archive, has shebang  → must be executable (shebang detection)
  printf '#!/usr/bin/env python3\nprint("hi")\n' > "$tmpdir/also_run.py"

  # library.py: no +x, no shebang  → must NOT be executable
  printf 'def foo(): pass\n' > "$tmpdir/library.py"

  # pre_marked.sh: +x in archive, no shebang  → must be executable (archive bit)
  printf 'echo pre\n' > "$tmpdir/pre_marked.sh"
  chmod +x "$tmpdir/pre_marked.sh"

  # Build zip preserving permissions
  local zipfile
  zipfile=$(mktemp /tmp/ziextract-test-XXXXXX.zip)
  ( cd "$tmpdir" && zip -q "$zipfile" run_me.sh also_run.py library.py pre_marked.sh )

  run zinit as"null" id-as"test/ziextract-permissions" extract for "$zipfile"
  assert $state equals 0

  local plugdir="$ZPLUGINS/test---ziextract-permissions"
  assert "$plugdir/run_me.sh"    is_executable
  assert "$plugdir/also_run.py"  is_executable
  assert "$plugdir/pre_marked.sh" is_executable
  assert "$plugdir/library.py"   is_not_executable

  rm -f "$zipfile"
  rm -rf "$tmpdir"
}

# vim:ft=zsh:sw=2:sts=2:et:foldmarker=\ {,}:foldmethod=marker
